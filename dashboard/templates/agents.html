{% extends "base.html" %}

{% block title %}Agents - Multi-Agent Dashboard{% endblock %}

{% block content %}
{# Page Header #}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-white">Agent Monitoring</h1>
            <p class="text-gray-400 mt-1">Track active Claude agent sessions and their activity</p>
        </div>
        <div class="flex items-center space-x-4">
            <span id="ws-status" class="flex items-center space-x-2">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                <span class="text-sm text-gray-400">Auto-refreshing</span>
            </span>
            <button
                id="refresh-btn"
                class="px-3 py-1.5 text-sm bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors"
                onclick="refreshAgents()"
            >
                Refresh Now
            </button>
        </div>
    </div>
</div>

{# Stats Summary Cards #}
<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">Online</span>
            <span class="h-8 w-8 rounded-full bg-primary-900/50 flex items-center justify-center">
                <svg class="h-4 w-4 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
            </span>
        </div>
        <p id="stat-total" class="text-2xl font-bold text-white mt-2">0</p>
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">Working</span>
            <span class="h-8 w-8 rounded-full bg-green-900/50 flex items-center justify-center">
                <svg class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
            </span>
        </div>
        <p id="stat-working" class="text-2xl font-bold text-white mt-2">0</p>
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">Idle</span>
            <span class="h-8 w-8 rounded-full bg-yellow-900/50 flex items-center justify-center">
                <svg class="h-4 w-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </span>
        </div>
        <p id="stat-idle" class="text-2xl font-bold text-white mt-2">0</p>
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">Developers</span>
            <span class="h-8 w-8 rounded-full bg-green-900/50 flex items-center justify-center">
                <svg class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
            </span>
        </div>
        <p id="stat-developers" class="text-2xl font-bold text-white mt-2">0</p>
    </div>
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
        <div class="flex items-center justify-between">
            <span class="text-gray-400 text-sm">Crashed</span>
            <span class="h-8 w-8 rounded-full bg-red-900/50 flex items-center justify-center">
                <svg class="h-4 w-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </span>
        </div>
        <p id="stat-crashed" class="text-2xl font-bold text-white mt-2">0</p>
    </div>
</div>

{# Filters #}
<div class="mb-6 flex items-center space-x-4">
    <div>
        <label for="filter-role" class="block text-sm font-medium text-gray-400 mb-1">Filter by Role</label>
        <select id="filter-role" onchange="refreshAgents()"
                class="bg-gray-700 border border-gray-600 text-white rounded-md px-3 py-2 text-sm">
            <option value="">All Roles</option>
            <option value="dev">Developer</option>
            <option value="qa">QA</option>
            <option value="reviewer">Reviewer</option>
            <option value="tech_lead">Tech Lead</option>
            <option value="manager">Manager</option>
        </select>
    </div>
    <div>
        <label for="filter-status" class="block text-sm font-medium text-gray-400 mb-1">Filter by Status</label>
        <select id="filter-status" onchange="filterAgentsByStatus()"
                class="bg-gray-700 border border-gray-600 text-white rounded-md px-3 py-2 text-sm">
            <option value="">All Statuses</option>
            <option value="working">Working</option>
            <option value="idle">Idle</option>
            <option value="crashed">Crashed</option>
            <option value="stopped">Stopped</option>
        </select>
    </div>
    <div class="flex-1"></div>
    <div class="flex items-center space-x-2 text-sm text-gray-400">
        <span>Last updated:</span>
        <span id="last-updated">-</span>
    </div>
</div>

{# Main Content: Agent Grid and Log Viewer #}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {# Agent Cards Grid #}
    <div class="lg:col-span-2">
        <div class="bg-gray-800 rounded-lg border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white">Active Agents</h3>
                <span id="agent-count" class="text-sm text-gray-400">0 agents</span>
            </div>
            <div id="agents-grid" class="p-4">
                {# Loading state #}
                <div id="agents-loading" class="flex items-center justify-center py-12">
                    <svg class="animate-spin h-8 w-8 text-primary-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                {# Agent cards will be rendered here grouped by role #}
                <div id="agents-list" class="hidden space-y-6"></div>
                {# Error state #}
                <div id="agents-error" class="hidden flex flex-col items-center justify-center py-12">
                    <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p class="text-gray-300 font-medium">Failed to load agents</p>
                    <p id="agents-error-msg" class="text-sm text-gray-500 mt-1">Could not connect to the server</p>
                    <button onclick="refreshAgents()" class="mt-4 px-4 py-2 text-sm bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors flex items-center space-x-2">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span>Retry</span>
                    </button>
                </div>
                {# Empty state #}
                <div id="agents-empty" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <p class="mt-4 text-gray-400">No active agents detected</p>
                    <p class="mt-1 text-sm text-gray-500">Spawn workers from the Admin page to see agents here</p>
                </div>
            </div>
        </div>
    </div>

    {# Agent Log Viewer (Side Panel) #}
    <div class="lg:col-span-1">
        <div class="bg-gray-800 rounded-lg border border-gray-700 sticky top-4">
            <div class="px-4 py-3 border-b border-gray-700 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-white" id="log-viewer-title">Agent Logs</h3>
                <div class="flex items-center space-x-2">
                    <span id="log-viewer-status" class="flex items-center space-x-1">
                        <span class="h-2 w-2 rounded-full bg-gray-500"></span>
                        <span class="text-xs text-gray-500">Select an agent</span>
                    </span>
                    <button onclick="clearAgentLogViewer()" class="text-xs text-gray-400 hover:text-white px-2 py-1 rounded hover:bg-gray-700">
                        Clear
                    </button>
                </div>
            </div>
            <div id="agent-log-viewer" class="h-96 overflow-y-auto p-3 font-mono text-xs bg-gray-900">
                <div class="text-gray-500 text-center py-8">
                    Click an agent to view their logs
                </div>
            </div>
            <div class="px-4 py-2 border-t border-gray-700 flex items-center justify-between text-xs">
                <span id="log-viewer-count" class="text-gray-500">0 entries</span>
                <label class="flex items-center space-x-1 text-gray-400 cursor-pointer">
                    <input id="log-autoscroll" type="checkbox" checked
                           class="rounded bg-gray-700 border-gray-600 text-primary-500 focus:ring-primary-500 h-3 w-3">
                    <span>Auto-scroll</span>
                </label>
            </div>
        </div>
    </div>
</div>

{# Bead Detail Modal #}
<div id="bead-detail-modal"></div>

{% endblock %}

{% block scripts %}
<script>
    // Store agents data
    let agents = [];
    let currentAgentPid = null;
    let currentWorkerId = null;
    let logEventSource = null;
    let logEntryCount = 0;
    let daemonRunning = true;  // Track daemon status for spawn button state

    // Fetch with timeout (10s default)
    function fetchWithTimeout(url, options = {}, timeoutMs = 10000) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), timeoutMs);
        return fetch(url, { ...options, signal: controller.signal })
            .finally(() => clearTimeout(timeout));
    }

    // Track whether we've ever loaded agents successfully
    let hasLoadedAgents = false;

    // Role configuration
    const roleConfig = {
        dev: { bg: 'bg-green-900', text: 'text-green-300', border: 'border-green-600', dot: 'bg-green-500', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />' },
        qa: { bg: 'bg-blue-900', text: 'text-blue-300', border: 'border-blue-600', dot: 'bg-blue-500', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' },
        tech_lead: { bg: 'bg-yellow-900', text: 'text-yellow-300', border: 'border-yellow-600', dot: 'bg-yellow-500', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />' },
        manager: { bg: 'bg-purple-900', text: 'text-purple-300', border: 'border-purple-600', dot: 'bg-purple-500', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />' },
        reviewer: { bg: 'bg-cyan-900', text: 'text-cyan-300', border: 'border-cyan-600', dot: 'bg-cyan-500', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />' },
        unknown: { bg: 'bg-gray-800', text: 'text-gray-300', border: 'border-gray-600', dot: 'bg-gray-500', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />' }
    };

    // Event colors for log display
    const eventColors = {
        'SESSION_START': 'text-green-400',
        'SESSION_END': 'text-green-400',
        'CLAIM': 'text-blue-400',
        'READ': 'text-blue-300',
        'WORK_START': 'text-blue-300',
        'CLOSE': 'text-purple-400',
        'TESTS': 'text-cyan-400',
        'TESTS_PASSED': 'text-green-400',
        'TESTS_FAILED': 'text-red-400',
        'ERROR': 'text-red-500',
        'BLOCKED': 'text-orange-400',
        'BEAD_CREATE': 'text-purple-300',
        'PR_CREATE': 'text-indigo-400',
        'PR_CREATED': 'text-indigo-400',
        'PR_MERGED': 'text-green-400',
        'CI': 'text-cyan-400',
        'NO_WORK': 'text-yellow-400'
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        refreshAgents();
        // Auto-refresh every 5 seconds
        setInterval(refreshAgents, 5000);
    });

    // Fetch and display agents (single data source: /api/workers with bead info)
    async function refreshAgents() {
        const roleFilter = document.getElementById('filter-role').value;
        let workersUrl = '/api/workers';
        const params = new URLSearchParams();
        if (roleFilter) {
            params.append('role', roleFilter);
        }
        if (params.toString()) {
            workersUrl += '?' + params.toString();
        }

        const loading = document.getElementById('agents-loading');
        const errorEl = document.getElementById('agents-error');

        // Show loading on first load or retry
        if (!hasLoadedAgents) {
            loading.classList.remove('hidden');
            errorEl.classList.add('hidden');
            document.getElementById('agents-list').classList.add('hidden');
            document.getElementById('agents-empty').classList.add('hidden');
        }

        try {
            const workersResponse = await fetchWithTimeout(workersUrl);

            if (workersResponse.ok) {
                hasLoadedAgents = true;
                daemonRunning = true;
                errorEl.classList.add('hidden');
                const data = await workersResponse.json();
                // Transform worker data to display format
                // Bead info (current_bead, current_bead_title) is included in worker data
                agents = (data.workers || []).map(worker => {
                    // Map worker status to display status
                    let displayStatus;
                    switch (worker.status) {
                        case 'running':
                            displayStatus = worker.current_bead ? 'working' : 'working';
                            break;
                        case 'crashed':
                            displayStatus = 'crashed';
                            break;
                        case 'stopped':
                            displayStatus = 'stopped';
                            break;
                        default:
                            displayStatus = 'idle';
                    }

                    // If worker has a claimed bead, show as working
                    if (worker.current_bead && displayStatus !== 'crashed' && displayStatus !== 'stopped') {
                        displayStatus = 'working';
                    }

                    return {
                        role: worker.role || 'unknown',
                        instance: 1,
                        current_bead: worker.current_bead || null,
                        current_bead_title: worker.current_bead_title || null,
                        status: displayStatus,
                        last_activity: worker.stopped_at || worker.started_at || new Date().toISOString(),
                        pid: worker.pid || null,
                        worker_id: worker.id,
                        worktree_path: worker.worktree_path || null,
                        worktree_branch: worker.worktree_branch || null
                    };
                });
                renderAgents(agents);
                updateStats(agents);
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } else if (workersResponse.status === 503) {
                // Daemon not running - show empty state and disable spawn buttons
                hasLoadedAgents = true;
                daemonRunning = false;
                errorEl.classList.add('hidden');
                agents = [];
                renderAgents(agents);
                updateStats(agents);
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } else {
                throw new Error('Server returned ' + workersResponse.status);
            }
        } catch (error) {
            console.error('Failed to fetch agents:', error);
            if (!hasLoadedAgents) {
                loading.classList.add('hidden');
                var msg = error.name === 'AbortError' ? 'Request timed out' : 'Could not connect to the server';
                document.getElementById('agents-error-msg').textContent = msg;
                errorEl.classList.remove('hidden');
            } else {
                showToast('Failed to refresh agents', 'error');
            }
        }
    }

    // Update statistics - "Online" only counts running workers (working + idle)
    function updateStats(agentList) {
        const working = agentList.filter(a => a.status === 'working').length;
        const idle = agentList.filter(a => a.status === 'idle').length;
        const crashed = agentList.filter(a => a.status === 'crashed').length;
        const developers = agentList.filter(a => a.role === 'dev').length;
        const totalOnline = working + idle;

        document.getElementById('stat-total').textContent = totalOnline;
        document.getElementById('stat-working').textContent = working;
        document.getElementById('stat-idle').textContent = idle;
        document.getElementById('stat-crashed').textContent = crashed;
        document.getElementById('stat-developers').textContent = developers;
    }

    // Track which roles are currently spawning
    const spawningRoles = new Set();

    // All available roles for display
    const allRoles = ['dev', 'qa', 'reviewer', 'tech_lead', 'manager'];

    // Role display names
    const roleDisplayNames = {
        dev: 'Developers',
        qa: 'QA',
        reviewer: 'Reviewers',
        tech_lead: 'Tech Leads',
        manager: 'Managers',
        unknown: 'Unknown'
    };

    // Render agent cards grouped by role
    function renderAgents(agentList) {
        const loading = document.getElementById('agents-loading');
        const list = document.getElementById('agents-list');
        const empty = document.getElementById('agents-empty');
        const count = document.getElementById('agent-count');

        loading.classList.add('hidden');

        // Apply client-side status filter
        const statusFilter = document.getElementById('filter-status').value;
        let filteredAgents = agentList;
        if (statusFilter) {
            filteredAgents = agentList.filter(a => a.status === statusFilter);
        }

        // Group agents by role
        const agentsByRole = {};
        filteredAgents.forEach(agent => {
            const role = agent.role || 'unknown';
            if (!agentsByRole[role]) {
                agentsByRole[role] = [];
            }
            agentsByRole[role].push(agent);
        });

        // Update count - show online vs stopped separately
        const onlineCount = filteredAgents.filter(a => a.status === 'working' || a.status === 'idle').length;
        const stoppedCount = filteredAgents.length - onlineCount;
        count.textContent = onlineCount + ' online' + (stoppedCount > 0 ? ', ' + stoppedCount + ' stopped' : '');

        // Render role sections (show all roles, even empty ones)
        const roleFilter = document.getElementById('filter-role').value;
        const rolesToShow = roleFilter ? [roleFilter] : allRoles;

        let html = '';
        rolesToShow.forEach(role => {
            const roleAgents = agentsByRole[role] || [];
            html += renderRoleSection(role, roleAgents);
        });

        // Show list if we have sections to render
        if (rolesToShow.length > 0) {
            empty.classList.add('hidden');
            list.classList.remove('hidden');
            list.innerHTML = html;
        } else {
            list.classList.add('hidden');
            empty.classList.remove('hidden');
        }
    }

    // Render a role section with header and agent cards
    function renderRoleSection(role, agents) {
        const config = roleConfig[role] || roleConfig.unknown;
        const displayName = roleDisplayNames[role] || role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        const isSpawning = spawningRoles.has(role);
        const isDisabled = isSpawning || !daemonRunning;
        const disabledReason = !daemonRunning ? 'Daemon not running - required to spawn agents' : '';

        return `
            <div class="role-section ${config.bg} bg-opacity-30 rounded-lg border ${config.border} border-opacity-50">
                <div class="px-4 py-3 border-b ${config.border} border-opacity-30 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <svg class="h-5 w-5 ${config.text}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${config.icon}
                        </svg>
                        <span class="font-medium ${config.text}">${displayName}</span>
                        <span class="text-sm text-gray-400">(${agents.length})</span>
                    </div>
                    <button
                        onclick="addWorker('${role}')"
                        ${isDisabled ? 'disabled' : ''}
                        ${disabledReason ? `title="${disabledReason}"` : ''}
                        class="px-3 py-1.5 text-sm ${!daemonRunning ? 'bg-gray-700 text-gray-500 border-gray-600' : config.bg + ' ' + config.text + ' border ' + config.border} rounded-md ${isDisabled ? '' : 'hover:opacity-80'} transition-colors flex items-center space-x-1 ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                    >
                        ${isSpawning ? `
                            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Adding...</span>
                        ` : `
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>+ Add ${displayName.replace(/s$/, '')}</span>
                        `}
                    </button>
                </div>
                <div class="p-4">
                    ${agents.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${agents.map(agent => renderAgentCard(agent)).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-6 text-gray-500 text-sm">
                            No ${displayName.toLowerCase()} active
                        </div>
                    `}
                </div>
            </div>
        `;
    }

    // Add a new worker via the API
    async function addWorker(role) {
        if (spawningRoles.has(role)) return;

        spawningRoles.add(role);
        renderAgents(agents); // Re-render to show loading state

        try {
            const response = await fetch('/api/workers/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: role, count: 1 })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast(`Added ${data.spawned} ${role} worker(s)`, 'success');
                // Refresh agents list after short delay to let worker initialize
                setTimeout(refreshAgents, 1000);
            } else {
                const errorMsg = data.errors?.join(', ') || data.detail || 'Failed to add worker';
                showToast(errorMsg, 'error');
            }
        } catch (error) {
            console.error('Failed to add worker:', error);
            showToast('Failed to add worker: ' + error.message, 'error');
        } finally {
            spawningRoles.delete(role);
            renderAgents(agents); // Re-render to remove loading state
        }
    }

    // Status configuration for visual overrides (crashed/stopped override role colors)
    const statusConfig = {
        crashed: { bg: 'bg-red-900', text: 'text-red-300', border: 'border-red-600', dot: 'bg-red-500' },
        stopped: { bg: 'bg-gray-900', text: 'text-gray-400', border: 'border-gray-600', dot: 'bg-gray-500' }
    };

    // Render a single agent card
    function renderAgentCard(agent) {
        // Use status-based styling for crashed/stopped, otherwise use role-based styling
        const baseConfig = roleConfig[agent.role] || roleConfig.unknown;
        const config = statusConfig[agent.status] || baseConfig;
        const isWorking = agent.status === 'working';
        const isCrashed = agent.status === 'crashed';
        const isStopped = agent.status === 'stopped';
        const isSelected = agent.pid === currentAgentPid;

        return `
            <div class="agent-card ${config.bg} rounded-lg p-4 border ${config.border} ${isSelected ? 'ring-2 ring-primary-500' : ''} hover:opacity-90 transition-all cursor-pointer"
                 data-status="${agent.status}"
                 onclick="selectAgent('${agent.worker_id}', ${agent.pid}, '${agent.role}')">
                {# Header: Role and status #}
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <svg class="h-5 w-5 ${config.text}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${config.icon}
                        </svg>
                        <span class="font-medium ${config.text}">
                            ${agent.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            ${agent.instance > 1 ? '<span class="text-xs opacity-75">#' + agent.instance + '</span>' : ''}
                        </span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="relative flex h-2.5 w-2.5">
                            ${isWorking ? '<span class="animate-ping absolute inline-flex h-full w-full rounded-full ' + config.dot + ' opacity-75"></span>' : ''}
                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 ${config.dot}"></span>
                        </span>
                        <span class="text-xs ${config.text} opacity-75">${agent.status}</span>
                    </div>
                </div>

                {# Current bead #}
                ${agent.current_bead ? `
                    <div class="mb-3">
                        <div class="text-xs ${config.text} opacity-75 mb-1">Working on:</div>
                        <div class="text-sm ${config.text} font-mono truncate" title="${agent.current_bead_title || agent.current_bead}">
                            ${agent.current_bead.split('-').pop().substring(0, 8)}
                            ${agent.current_bead_title ? ' - ' + escapeHtml(truncate(agent.current_bead_title, 25)) : ''}
                        </div>
                    </div>
                ` : `
                    <div class="mb-3">
                        <div class="text-xs text-gray-500 italic">No bead claimed</div>
                    </div>
                `}

                {# Worktree info #}
                ${agent.worktree_path ? `
                    <div class="mb-3">
                        <div class="text-xs ${config.text} opacity-75 mb-1">Worktree:</div>
                        <div class="text-xs text-gray-400 font-mono truncate" title="${agent.worktree_path}">
                            ${agent.worktree_path.split('/').slice(-2).join('/')}
                        </div>
                        ${agent.worktree_branch ? `
                            <div class="text-xs text-gray-500 font-mono truncate mt-0.5" title="Branch: ${agent.worktree_branch}">
                                <svg class="inline h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>${agent.worktree_branch}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                {# Footer: PID and last activity #}
                <div class="flex items-center justify-between text-xs">
                    <span class="font-mono text-gray-500">PID ${agent.pid ?? '-'}</span>
                    <span class="text-gray-500" title="Last activity: ${agent.last_activity}">
                        ${formatTimestamp(agent.last_activity)}
                    </span>
                </div>

                {# View logs button #}
                <div class="mt-3 pt-3 border-t ${config.border.replace('border-', 'border-t-')} border-opacity-50">
                    <button onclick="event.stopPropagation(); selectAgent('${agent.worker_id}', ${agent.pid}, '${agent.role}')"
                            class="w-full text-xs ${config.text} hover:underline flex items-center justify-center space-x-1">
                        <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>View Logs</span>
                    </button>
                </div>
            </div>
        `;
    }

    // Filter agents by status (client-side)
    function filterAgentsByStatus() {
        renderAgents(agents);
    }

    // Select an agent and show their logs
    function selectAgent(workerId, pid, role) {
        currentAgentPid = pid;
        currentWorkerId = workerId;
        logEntryCount = 0;

        // Update UI to show selected state
        document.querySelectorAll('.agent-card').forEach(card => {
            card.classList.remove('ring-2', 'ring-primary-500');
        });
        event.currentTarget.classList.add('ring-2', 'ring-primary-500');

        // Update log viewer title
        document.getElementById('log-viewer-title').textContent = `Logs: PID ${pid ?? '-'} (${role})`;

        // Clear log viewer
        const viewer = document.getElementById('agent-log-viewer');
        viewer.innerHTML = '<div class="text-gray-500 text-center py-4">Loading logs...</div>';

        // Update status
        updateLogViewerStatus('connecting');

        // Close existing SSE connection
        if (logEventSource) {
            logEventSource.close();
        }

        // Load recent logs first, then connect to SSE stream
        loadAgentRecentLogs(workerId).then(() => {
            connectAgentLogStream(workerId);
        });
    }

    // Load recent logs for an agent using worker-specific endpoint
    async function loadAgentRecentLogs(workerId) {
        try {
            // Use worker-specific endpoint which reads from correct log file
            const response = await fetch(`/api/workers/${workerId}/logs/recent?limit=200`);
            if (response.ok) {
                const logs = await response.json();
                const viewer = document.getElementById('agent-log-viewer');
                viewer.innerHTML = '';

                // Render logs (oldest first - API returns most recent first)
                logs.reverse().forEach(log => {
                    appendLogEntry(log);
                });

                if (logs.length === 0) {
                    viewer.innerHTML = '<div class="text-gray-500 text-center py-4">No recent logs for this agent</div>';
                }
            } else if (response.status === 404) {
                const viewer = document.getElementById('agent-log-viewer');
                viewer.innerHTML = '<div class="text-gray-500 text-center py-4">Worker not found or not running</div>';
            }
        } catch (error) {
            console.error('Failed to load recent logs:', error);
            const viewer = document.getElementById('agent-log-viewer');
            viewer.innerHTML = '<div class="text-red-400 text-center py-4">Failed to load logs</div>';
        }
    }

    // Connect to SSE log stream using worker-specific endpoint
    function connectAgentLogStream(workerId) {
        logEventSource = new EventSource(`/api/workers/${workerId}/logs/stream`);

        logEventSource.onopen = function() {
            updateLogViewerStatus('connected');
        };

        logEventSource.onmessage = function(event) {
            try {
                const entry = JSON.parse(event.data);
                appendLogEntry(entry);
            } catch (e) {
                console.error('Failed to parse log entry:', e);
            }
        };

        logEventSource.addEventListener('error', function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'fatal') {
                    updateLogViewerStatus('error');
                    const viewer = document.getElementById('agent-log-viewer');
                    const div = document.createElement('div');
                    div.className = 'py-1 text-red-400';
                    div.textContent = `Error: ${data.message}`;
                    viewer.appendChild(div);
                }
            } catch (e) {
                // Connection error - attempt reconnect
                updateLogViewerStatus('disconnected');
                setTimeout(() => {
                    if (currentWorkerId === workerId) {
                        connectAgentLogStream(workerId);
                    }
                }, 3000);
            }
        });
    }

    // Append a log entry to the viewer
    function appendLogEntry(entry) {
        const viewer = document.getElementById('agent-log-viewer');

        // Remove placeholder if present
        const placeholder = viewer.querySelector('.text-gray-500.text-center');
        if (placeholder) placeholder.remove();

        const div = document.createElement('div');
        div.className = 'py-1 border-b border-gray-800';

        const eventColor = eventColors[entry.event] || 'text-gray-400';

        div.innerHTML = `
            <span class="text-gray-500">${entry.timestamp.split(' ')[1] || entry.timestamp}</span>
            <span class="${eventColor} font-medium ml-2">${entry.event}</span>
            ${entry.message ? '<span class="text-gray-400 ml-2">' + escapeHtml(entry.message) + '</span>' : ''}
        `;

        viewer.appendChild(div);
        logEntryCount++;

        // Update count
        document.getElementById('log-viewer-count').textContent = logEntryCount + ' entries';

        // Auto-scroll if enabled
        const autoScroll = document.getElementById('log-autoscroll');
        if (autoScroll && autoScroll.checked) {
            viewer.scrollTop = viewer.scrollHeight;
        }
    }

    // Update log viewer status indicator
    function updateLogViewerStatus(status) {
        const statusEl = document.getElementById('log-viewer-status');
        const configs = {
            'connecting': { color: 'bg-yellow-500', text: 'Connecting...' },
            'connected': { color: 'bg-green-500', text: 'Live' },
            'disconnected': { color: 'bg-red-500', text: 'Reconnecting...' }
        };
        const config = configs[status] || configs.connecting;

        statusEl.innerHTML = `
            <span class="h-2 w-2 rounded-full ${config.color}"></span>
            <span class="text-xs text-gray-500">${config.text}</span>
        `;
    }

    // Clear log viewer
    function clearAgentLogViewer() {
        const viewer = document.getElementById('agent-log-viewer');
        viewer.innerHTML = '<div class="text-gray-500 text-center py-8">Click an agent to view their logs</div>';
        logEntryCount = 0;
        document.getElementById('log-viewer-count').textContent = '0 entries';
        document.getElementById('log-viewer-title').textContent = 'Agent Logs';
        updateLogViewerStatus('');

        // Close SSE connection
        if (logEventSource) {
            logEventSource.close();
            logEventSource = null;
        }
        currentAgentPid = null;
        currentWorkerId = null;

        // Remove selection from cards
        document.querySelectorAll('.agent-card').forEach(card => {
            card.classList.remove('ring-2', 'ring-primary-500');
        });
    }

    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function truncate(str, len) {
        if (!str) return '';
        return str.length > len ? str.substring(0, len) + '...' : str;
    }

    function formatTimestamp(iso) {
        if (!iso) return '-';
        try {
            const date = new Date(iso);
            return date.toLocaleTimeString();
        } catch {
            return iso.substring(11, 19);
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (logEventSource) {
            logEventSource.close();
        }
    });

    // --- WebSocket real-time updates ---
    let wsAgentRefreshTimer = null;

    function wsRefreshAgentsDebounced() {
        clearTimeout(wsAgentRefreshTimer);
        wsAgentRefreshTimer = setTimeout(refreshAgents, 300);
    }

    // Worker events → immediate refresh
    document.addEventListener('mab:ws:worker.spawned', function(e) {
        wsRefreshAgentsDebounced();
        showToast('Worker spawned: ' + (e.detail.role || ''), 'success');
    });
    document.addEventListener('mab:ws:worker.stopped', function(e) {
        wsRefreshAgentsDebounced();
        showToast('Worker stopped: ' + (e.detail.worker_id || ''), 'info');
    });
    document.addEventListener('mab:ws:worker.crashed', function(e) {
        wsRefreshAgentsDebounced();
        showToast('Worker crashed: ' + (e.detail.worker_id || ''), 'error');
    });
    document.addEventListener('mab:ws:worker.status', wsRefreshAgentsDebounced);

    // Agent session events → immediate refresh
    document.addEventListener('mab:ws:agent.session_start', wsRefreshAgentsDebounced);
    document.addEventListener('mab:ws:agent.session_end', wsRefreshAgentsDebounced);
    document.addEventListener('mab:ws:agent.claim', wsRefreshAgentsDebounced);

    // Update status indicator when WS connected
    document.addEventListener('mab:ws:connected', function() {
        var el = document.getElementById('ws-status');
        if (el) {
            el.innerHTML = '<span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span><span class="text-sm text-gray-400">Live</span>';
        }
    });
    document.addEventListener('mab:ws:disconnected', function() {
        var el = document.getElementById('ws-status');
        if (el) {
            el.innerHTML = '<span class="relative flex h-3 w-3"><span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span></span><span class="text-sm text-gray-400">Polling (5s)</span>';
        }
    });
</script>
{% endblock %}
